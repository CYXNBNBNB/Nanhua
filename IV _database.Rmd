---
title: "IV_database"
output: html_document
date: "2025-09-10"
---
```{r}
library(readxl)
library(dplyr)
library(stringr)
library(ggplot2)
library(scales)
```

```{r}
#输入认购（call）or 认沽（put）
type <- "call"

#输入create（创建新数据库） or add（添加新数据）
mod <- "add" 
```

```{r}
clean <- function(df) {
  
  df[1, 1] <- df[2, 1]
  
  df <- df[-2, ]
  
  colnames(df) <- as.character(unlist(df[1, ]))
  
  df <- df[-1, ]
  
  df[[1]] <- as.Date(as.numeric(df[[1]]), origin = "1899-12-30")
  
  if(ncol(df) > 1) {
    df[,-1] <- lapply(df[,-1], function(x) suppressWarnings(as.numeric(x)))
  }
  
  return(df)
}
```

*导入 or 创建数据库*
```{r}
if (mod == "create") {
  
  result_list_latest <- list()
  
} else if (mod == "add" && type == "call") {
  
  load("call_data.RData")

} else if (mod == "add" && type == "put") {
  
  load("put_data.RData")
  
}

```


*读取数据信息*
```{r}
# 在此处修改要导入的文件名
file_path <- "中证1000认购.xlsx"

close_price <- suppressMessages(read_excel(file_path, sheet = "收盘价", col_names = FALSE, skip = 2))
exercise_price <- suppressMessages(read_excel(file_path, sheet = "行权价格", col_names = FALSE, skip = 2))
target_close_price <- suppressMessages(read_excel(file_path, sheet = "标的收盘价", col_names = FALSE, skip = 2))
expire_date <- suppressMessages(read_excel(file_path, sheet = "到期日", col_names = FALSE, skip = 2))
volume <- suppressMessages(read_excel(file_path, sheet = "成交量", col_names = FALSE, skip = 2))
rf <- suppressMessages(read_excel(file_path, sheet = "无风险利率", col_names = FALSE, skip = 4))

ID <- data.frame(ID = t(close_price[1, -1]), stringsAsFactors = FALSE)

colnames(rf) <- c("时间", "无风险利率")
rf[,-1] <- lapply(rf[,-1], as.numeric)

close_price      <- clean(close_price)
exercise_price   <- clean(exercise_price)
target_close_price <- clean(target_close_price)
expire_date      <- clean(expire_date)
volume           <- clean(volume)

expire_date[-1] <- lapply(expire_date[-1], function(col) {
  as.Date(as.numeric(col), origin = "1899-12-30")
})

```


*检查收盘价、行权价格、标的收盘价、到期日和成交量的日期是否一致*
*检查期权数量是否正确*
```{r}
if(!all(nrow(volume) == nrow(close_price), 
        nrow(volume) == nrow(target_close_price),
        nrow(volume) == nrow(expire_date),
        nrow(volume) == nrow(exercise_price))) {
  stop("所有数据的行数必须相同")
}

if(!all(ncol(volume)-1 == nrow(ID))) { 
  stop("所有数据的ID必须相同")
}

```


```{r}
ids <- as.character(ID[[1]])

ID$Expire_Date <- as.Date(NA)
ID$Exercise_Price <- NA_real_ 

for(i in 1:length(ids)) {
  id <- ids[i]

  if(id %in% colnames(expire_date)) {
    expiry <- na.omit(expire_date[[id]])
    if(length(expiry) > 0) {
      ID$Expire_Date[i] <- expiry[1] 
    }
  }

  if(id %in% colnames(exercise_price)) {
    exercise_price_vals <- na.omit(exercise_price[[id]])
    if(length(exercise_price_vals) > 0) {
      ID$Exercise_Price[i] <- exercise_price_vals[1]
    }
  }
}


for(id in ids) {
  if(id %in% colnames(close_price) && id %in% colnames(volume)) {
    expiry_date <- ID$Expire_Date[ID[[1]] == id]
    
    if(!is.na(expiry_date)) {
      expire_after_indices <- which(close_price$时间 > expiry_date)

      if(length(expire_after_indices) > 0) {
        close_price[expire_after_indices, id] <- 0
        volume[expire_after_indices, id] <- 0
      }
    }
  }
}

```


*按时间序列 合并每个ID当日的收盘价、成交量和标的收盘价*
*把ID提取的到期日和收盘价合并*
```{r}
result_list <- list()

for(i in 2:nrow(volume)) {

  current_date <- volume$时间[i]

  volume_values <- as.numeric(volume[i, -1]) 
  close_price_values <- as.numeric(close_price[i, -1]) 
  target_close_price_values <- as.numeric(target_close_price[i, -1]) 

  expire_date_values <- ID$Expire_Date[match(ids, ID[[1]])]
  exercise_price_values <- ID$Exercise_Price[match(ids, ID[[1]])]

  date_data <- data.frame(
    ID = ids,
    Volume = volume_values,
    Close_Price = close_price_values,
    Target_Close_Price = target_close_price_values,
    Expire_Date = expire_date_values,
    Exercise_Price = exercise_price_values,
    stringsAsFactors = FALSE
  )

  date_data <- subset(
  date_data,
  !( (is.na(Volume) | Volume == 0) & (is.na(Close_Price) | Close_Price == 0) ) 
)


  if(nrow(date_data) > 0 && !all(is.na(date_data[, -1]))) {
    result_list[[as.character(current_date)]] <- date_data
  }
}

cat("处理完成，有效日期数量:", length(result_list), "\n")
```


*添加无风险利率rf，使其与日期匹配*
```{r}
rf$时间 <- as.Date(rf$时间, format="%Y/%m/%d")

for(date_str in names(result_list)) {

  current_date <- as.Date(date_str)

  rf_row <- rf[rf$时间 == current_date, ]
  
  if(nrow(rf_row) > 0) {
    rf_value <- as.numeric(rf_row[1, 2])

    result_list[[date_str]]$rf <- rf_value
  } else {

    warning(paste("在rf数据框中找不到日期:", current_date))
    result_list[[date_str]]$rf <- NA
  }
}

missing_rf_dates <- sapply(result_list, function(x) all(is.na(x$rf)))
if(any(missing_rf_dates)) {
  cat("以下日期缺少rf值:", toString(names(result_list)[missing_rf_dates]), "\n")
} else {
  cat("所有日期都成功添加了rf值\n")
}
```


*level 排序 实值期权\虚值期权*
```{r}
for(date_str in names(result_list)) {
  date_data <- result_list[[date_str]]

  date_data <- date_data %>%
    mutate(diff = abs(Target_Close_Price - Exercise_Price))

  min_diff_idx <- which.min(date_data$diff)
  date_data$level <- 0  

  at_the_money_strike <- date_data$Exercise_Price[min_diff_idx]

  greater_than_atm <- date_data %>%
    filter(Exercise_Price > at_the_money_strike)
  less_than_atm <- date_data %>%
    filter(Exercise_Price < at_the_money_strike)

  at_the_money <- date_data %>%
    filter(Exercise_Price == at_the_money_strike)

  greater_than_atm <- greater_than_atm %>%
    arrange(Exercise_Price) %>%
    mutate(level = dense_rank(Exercise_Price))

  less_than_atm <- less_than_atm %>%
    arrange(desc(Exercise_Price)) %>%
    mutate(level = -dense_rank(desc(Exercise_Price))) 

  date_data <- bind_rows(greater_than_atm, less_than_atm, at_the_money)

  result_list[[date_str]] <- date_data
}

```


*合并新旧数据*
```{r}
dates_A <- names(result_list)
dates_B <- names(result_list_latest)
all_dates <- sort(unique(c(dates_A, dates_B)), decreasing = TRUE)

result_list_combine <- list()

for (d in all_dates) {
  if (d %in% dates_A & d %in% dates_B) {
    df_A <- result_list[[d]]
    df_B <- result_list_latest[[d]]
    merged_df <- bind_rows(df_A, df_B) %>% distinct()
    result_list_combine[[d]] <- merged_df
  } else if (d %in% dates_A) {
    result_list_combine[[d]] <- result_list[[d]]
  } else {
    result_list_combine[[d]] <- result_list_latest[[d]]
  }
}

for (d in names(result_list_combine)) {
  result_list_combine[[d]] <- result_list_combine[[d]] %>% filter(if_any(everything(), ~ !is.na(.)))
}

```


*对比行权价格与标的收盘价，确定当日的平值期权（可能有多个）*
```{r}
ID$Exercise_Price <- as.numeric(ID$Exercise_Price)
At_the_money <- result_list_combine  

At_the_money <- lapply(At_the_money, function(date_data) {

  date_data <- date_data %>%
    mutate(diff = abs(Target_Close_Price - Exercise_Price))
  
  min_diff <- min(date_data$diff, na.rm = TRUE)

  date_data <- date_data %>% filter(diff == min_diff)
  
  return(date_data)
})

```

*筛选掉临近到期日的合约*
```{r}
library(lubridate)

for (i in seq_along(At_the_money)) {
  current_date <- as.Date(names(At_the_money)[i])
  df <- At_the_money[[i]]

  df$Expire_Date <- as.Date(df$Expire_Date)
  
  # 筛选：到期日距离当前日期 > 1 天
  df <- df[df$Expire_Date - current_date > 1, ]

  At_the_money[[i]] <- df
}

```


*按每日最大成交量筛选主力合约*
```{r}
atm_max_vol <- lapply(At_the_money, function(date_data) {
  if(nrow(date_data) == 0) return(date_data[0, ])
  
  max_vol <- max(date_data$Volume, na.rm = TRUE)
  date_data %>% filter(Volume == max_vol)
})

atm_max_vol_df <- bind_rows(atm_max_vol, .id = "Date") %>%
  select(-diff)
```


## *计算隐含波动率* 
```{r}
##########################  Black-Scholes 欧式看涨期权定价公式  ###################################

bs_call_price <- function(S, K, r, T, sigma) {
  d1 <- (log(S/K) + (r + 0.5*sigma^2)*T) / (sigma*sqrt(T))
  d2 <- d1 - sigma*sqrt(T)
  C <- S * pnorm(d1) - K * exp(-r*T) * pnorm(d2)
  return(C)
}

implied_vol_call <- function(C_market, S, K, r, T, 
                        sigma_lower=1e-6, sigma_upper=5) {

  if (C_market <= max(S - K * exp(-r*T), 0) || C_market > S) {
    return(NA)  
  }
  
  tryCatch({
    uniroot(function(sigma) bs_call_price(S, K, r, T, sigma) - C_market, 
            lower=sigma_lower, upper=sigma_upper)$root
  }, error=function(e) {

    message(sprintf("IV calculation failed for S=%.4f, K=%.4f, T=%.4f, C=%.4f, r=%.4f: %s", 
                    S, K, T, C_market, r, e$message))
    NA
  })
}

calculate_iv_call <- function(df) {
  df %>%
    mutate(

      Date = as.Date(Date),
      Expire_Date = as.Date(Expire_Date),

      T = as.numeric(difftime(Expire_Date, Date, units = "days")) / 365,

      IV = mapply(
        function(c_market, S, K, r, T_val) {

          if (is.na(c_market) || is.na(S) || is.na(K) || is.na(r) || is.na(T_val) || 
              T_val <= 0 || S <= 0 || K <= 0 || c_market <= 0) {
            return(NA)
          }

          implied_vol_call(c_market, S, K, r/100, T_val)
        },
        Close_Price, Target_Close_Price, Exercise_Price, rf, T
      )
    ) %>%
    select(-T)
}




##########################  Black-Scholes 欧式看跌期权定价公式  ###################################

bs_put_price <- function(S, K, r, T, sigma) {
  d1 <- (log(S/K) + (r + 0.5*sigma^2)*T) / (sigma*sqrt(T))
  d2 <- d1 - sigma*sqrt(T)
  P <- K * exp(-r*T) * pnorm(-d2) - S * pnorm(-d1)
  return(P)
}

implied_vol_put <- function(P_market, S, K, r, T, 
                            sigma_lower=1e-6, sigma_upper=5) {

  if (P_market <= max(K * exp(-r*T) - S, 0) || P_market > S) {
    return(NA)
  }
  
  tryCatch({
    uniroot(function(sigma) bs_put_price(S, K, r, T, sigma) - P_market, 
            lower=sigma_lower, upper=sigma_upper)$root
  }, error=function(e) {
    message(sprintf("IV calculation failed for S=%.4f, K=%.4f, T=%.4f, P=%.4f, r=%.4f: %s", 
                    S, K, T, P_market, r, e$message))
    NA
  })
}

calculate_iv_put <- function(df) {
  df %>%
    mutate(
      Date = as.Date(Date),
      Expire_Date = as.Date(Expire_Date),

      T = as.numeric(difftime(Expire_Date, Date, units = "days")) / 365,

      IV = mapply(
        function(p_market, S, K, r, T_val) {
          if (is.na(p_market) || is.na(S) || is.na(K) || is.na(r) || is.na(T_val) || 
              T_val <= 0 || S <= 0 || K <= 0 || p_market <= 0) {
            return(NA)
          }

          implied_vol_put(p_market, S, K, r/100, T_val)
        },
        Close_Price, Target_Close_Price, Exercise_Price, rf, T
      )
    ) %>%
    select(-T)
}

```

```{r}
if (type == "call"){
  atm_max_vol_df <- calculate_iv_call(atm_max_vol_df)
} else if (type == "put") {
  atm_max_vol_df <- calculate_iv_put(atm_max_vol_df)
}

```



*更新IV数据，保存更新后的往期数据*
```{r}
library(openxlsx)
result_list_latest <- result_list_combine
atm_max_vol_df_latest <- atm_max_vol_df

if (type == "call"){
  write.xlsx(atm_max_vol_df_latest, file = "IV_call_results.xlsx")
  save(result_list_latest, atm_max_vol_df_latest, file = "call_data.RData")
} else if (type == "put") {
  write.xlsx(atm_max_vol_df_latest, file = "IV_put_results.xlsx")
  save(result_list_latest, atm_max_vol_df_latest, file = "put_data.RData")
}
```