---
title: "update"
output: html_document
date: "2025-10-15"
---

```{r}
library(readxl)
library(dplyr)
library(stringr)
library(ggplot2)
library(scales)
library(plotly)
```


## *导入历史数据*
```{r}
#输入认购（call）or 认沽（put）
type <- "call"

if (type == "call"){
  load("call_data.RData")
} else if (type == "put") {
  load("put_data.RData")
}
```


```{r}
clean <- function(df) {

  df[1, 1] <- df[2, 1]

  df <- df[-2, ]

  colnames(df) <- as.character(unlist(df[1, ]))
  df <- df[-1, ]

  df[[1]] <- as.Date(as.numeric(df[[1]]), origin = "1899-12-30")

  if(ncol(df) > 1) {
    df[,-1] <- lapply(df[,-1], function(x) suppressWarnings(as.numeric(x)))
  }

  return(df)
}
```

## *导入新数据*
```{r}
# 在此处修改要导入的文件名
file_path <- "中证1000认购update.xlsx"

close_price <- suppressMessages(read_excel(file_path, sheet = "收盘价", col_names = FALSE, skip = 2))
exercise_price <- suppressMessages(read_excel(file_path, sheet = "行权价格", col_names = FALSE, skip = 2))
target_close_price <- suppressMessages(read_excel(file_path, sheet = "标的收盘价", col_names = FALSE, skip = 2))
expire_date <- suppressMessages(read_excel(file_path, sheet = "到期日", col_names = FALSE, skip = 2))
volume <- suppressMessages(read_excel(file_path, sheet = "成交量", col_names = FALSE, skip = 2))
rf <- suppressMessages(read_excel(file_path, sheet = "无风险利率", col_names = FALSE, skip = 4))

ID <- data.frame(ID = t(close_price[1, -1]), stringsAsFactors = FALSE)

colnames(rf) <- c("时间", "无风险利率")
rf[,-1] <- lapply(rf[,-1], as.numeric)

close_price      <- clean(close_price)
exercise_price   <- clean(exercise_price)
target_close_price <- clean(target_close_price)
expire_date      <- clean(expire_date)
volume           <- clean(volume)

expire_date[-1] <- lapply(expire_date[-1], function(col) {
  as.Date(as.numeric(col), origin = "1899-12-30")
})

```


```{r}
if(!all(nrow(volume) == nrow(close_price), 
        nrow(volume) == nrow(target_close_price),
        nrow(volume) == nrow(expire_date),
        nrow(volume) == nrow(exercise_price))) {
  stop("所有数据的行数必须相同")
}

if(!all(ncol(volume)-1 == nrow(ID))) {
  stop("所有数据的ID必须相同")
}

```


*筛选缺失的交易日*
```{r}

latest_date <- as.Date(names(result_list_latest)[1])
today <- Sys.Date()

if (latest_date + 1 > today - 1) {
  diff_dates <- close_price$时间[close_price$时间 != today]
} else {
  diff_dates <- seq(from = latest_date + 1, to = today - 1, by = "day")
  diff_dates <- diff_dates[diff_dates %in% volume$时间]
}

print(diff_dates)
```


*将expire_date，exercise_price写入ID*
```{r}

ids <- as.character(ID[[1]])

ID$Expire_Date <- as.Date(NA)
ID$Exercise_Price <- NA_real_

for(i in 1:length(ids)) {
  id <- ids[i]

  if(id %in% colnames(expire_date)) {

    expiry <- na.omit(expire_date[[id]])
    if(length(expiry) > 0) {
      ID$Expire_Date[i] <- expiry[1]
    }
  }

  if(id %in% colnames(exercise_price)) {

    exercise_price_vals <- na.omit(exercise_price[[id]])
    if(length(exercise_price_vals) > 0) {
      ID$Exercise_Price[i] <- exercise_price_vals[1]
    }
  }
}

```

*如果在expire_date之后还有数据，就将其设置为0*
```{r}
for(id in ids) {
  if(id %in% colnames(close_price) && id %in% colnames(volume)) {
    expiry_date <- ID$Expire_Date[ID[[1]] == id]
    
    if(!is.na(expiry_date)) {
      expire_after_indices <- which(close_price$时间 > expiry_date)
      
      if(length(expire_after_indices) > 0) {
        close_price[expire_after_indices, id] <- 0
        volume[expire_after_indices, id] <- 0
      }
    }
  }
}
```

*筛选需要日期的数据*
```{r}
update_list <- list()

for(i in 1:nrow(volume)) {
  current_date <- volume$时间[i]

  if(current_date %in% diff_dates) {

    volume_values <- as.numeric(volume[i, -1])
    close_price_values <- as.numeric(close_price[i, -1])
    target_close_price_values <- as.numeric(target_close_price[i, -1])

    expire_date_values <- ID$Expire_Date[match(ids, ID[[1]])]
    exercise_price_values <- ID$Exercise_Price[match(ids, ID[[1]])]

    date_data <- data.frame(
      ID = ids,
      Volume = volume_values,
      Close_Price = close_price_values,
      Target_Close_Price = target_close_price_values,
      Expire_Date = expire_date_values,
      Exercise_Price = exercise_price_values,
      stringsAsFactors = FALSE
    )

    date_data <- subset(
      date_data,
      !( (is.na(Volume) | Volume == 0) & (is.na(Close_Price) | Close_Price == 0) )
    )

    if(nrow(date_data) > 0 && !all(is.na(date_data[, -1]))) {
      update_list[[as.character(current_date)]] <- date_data
    }
  }
}

cat("处理完成，有效日期数量:", length(update_list), "\n")

```


*添加无风险利率rf，使其与日期匹配*
```{r}
rf$时间 <- as.Date(rf$时间)

for(date_str in names(update_list)) {
  current_date <- as.Date(date_str)
  
  rf_row <- rf[rf$时间 == current_date, ]
  
  if(nrow(rf_row) > 0) {
    update_list[[date_str]]$rf <- rf_row$无风险利率[1]
  } else {
    warning(paste("在rf数据框中找不到日期:", current_date))
    update_list[[date_str]]$rf <- NA
  }
}

missing_rf_dates <- sapply(update_list, function(x) all(is.na(x$rf)))
if(any(missing_rf_dates)) {
  cat("以下日期缺少rf值:", toString(names(update_list)[missing_rf_dates]), "\n")
} else {
  cat("所有日期都成功添加了rf值\n")
}

```


*level 排序 实值期权\虚值期权*
```{r}
for(date_str in names(update_list)) {
  date_data <- update_list[[date_str]]

  date_data <- date_data %>%
    mutate(diff = abs(Target_Close_Price - Exercise_Price))

  min_diff_idx <- which.min(date_data$diff)
  date_data$level <- 0

  at_the_money_strike <- date_data$Exercise_Price[min_diff_idx]

  greater_than_atm <- date_data %>%
    filter(Exercise_Price > at_the_money_strike)
  less_than_atm <- date_data %>%
    filter(Exercise_Price < at_the_money_strike)

  at_the_money <- date_data %>%
    filter(Exercise_Price == at_the_money_strike)

  greater_than_atm <- greater_than_atm %>%
    arrange(Exercise_Price) %>%
    mutate(level = dense_rank(Exercise_Price))

  less_than_atm <- less_than_atm %>%
    arrange(desc(Exercise_Price)) %>%
    mutate(level = -dense_rank(desc(Exercise_Price)))

  date_data <- bind_rows(greater_than_atm, less_than_atm, at_the_money)

  update_list[[date_str]] <- date_data
}

```


## *筛选掉临近到期日的合约*
```{r}
library(lubridate)

for (i in seq_along(update_list)) {
  current_date <- as.Date(names(update_list)[i])
  df <- update_list[[i]]

  df$Expire_Date <- as.Date(df$Expire_Date)
  
  # 筛选：到期日距离当前日期 > 1 天
  df <- df[df$Expire_Date - current_date > 1, ]

  update_list[[i]] <- df
}

```


*对比行权价格与标的收盘价，确定当日的平值期权（可能有多个）*
```{r}
ID$Exercise_Price <- as.numeric(ID$Exercise_Price)
At_the_money <- update_list  

At_the_money <- lapply(At_the_money, function(date_data) {

  date_data <- date_data %>%
    mutate(diff = abs(Target_Close_Price - Exercise_Price))
  
  min_diff <- min(date_data$diff, na.rm = TRUE)

  date_data <- date_data %>% filter(diff == min_diff)
  
  return(date_data)
})

```


*按每日最大成交量筛选主力合约*
```{r}
atm_max_vol <- lapply(At_the_money, function(date_data) {
  if(nrow(date_data) == 0) return(date_data[0, ])
  
  max_vol <- max(date_data$Volume, na.rm = TRUE)
  date_data %>% filter(Volume == max_vol)
})

atm_max_vol_df <- bind_rows(atm_max_vol, .id = "Date") %>%
  select(-diff)
```


*计算隐含波动率* 
```{r}
##########################  Black-Scholes 欧式看涨期权定价公式  ###################################

bs_call_price <- function(S, K, r, T, sigma) {
  d1 <- (log(S/K) + (r + 0.5*sigma^2)*T) / (sigma*sqrt(T))
  d2 <- d1 - sigma*sqrt(T)
  C <- S * pnorm(d1) - K * exp(-r*T) * pnorm(d2)
  return(C)
}

implied_vol_call <- function(C_market, S, K, r, T, 
                        sigma_lower=1e-6, sigma_upper=5) {

  if (C_market <= max(S - K * exp(-r*T), 0) || C_market > S) {
    return(NA)  
  }
  
  tryCatch({
    uniroot(function(sigma) bs_call_price(S, K, r, T, sigma) - C_market, 
            lower=sigma_lower, upper=sigma_upper)$root
  }, error=function(e) {

    message(sprintf("IV calculation failed for S=%.4f, K=%.4f, T=%.4f, C=%.4f, r=%.4f: %s", 
                    S, K, T, C_market, r, e$message))
    NA
  })
}

calculate_iv_call <- function(df) {
  df %>%
    mutate(

      Date = as.Date(Date),
      Expire_Date = as.Date(Expire_Date),

      T = as.numeric(difftime(Expire_Date, Date, units = "days")) / 365,

      IV = mapply(
        function(c_market, S, K, r, T_val) {

          if (is.na(c_market) || is.na(S) || is.na(K) || is.na(r) || is.na(T_val) || 
              T_val <= 0 || S <= 0 || K <= 0 || c_market <= 0) {
            return(NA)
          }

          implied_vol_call(c_market, S, K, r/100, T_val)
        },
        Close_Price, Target_Close_Price, Exercise_Price, rf, T
      )
    ) %>%
    select(-T)
}




##########################  Black-Scholes 欧式看跌期权定价公式  ###################################

bs_put_price <- function(S, K, r, T, sigma) {
  d1 <- (log(S/K) + (r + 0.5*sigma^2)*T) / (sigma*sqrt(T))
  d2 <- d1 - sigma*sqrt(T)
  P <- K * exp(-r*T) * pnorm(-d2) - S * pnorm(-d1)
  return(P)
}

implied_vol_put <- function(P_market, S, K, r, T, 
                            sigma_lower=1e-6, sigma_upper=5) {

  if (P_market <= max(K * exp(-r*T) - S, 0) || P_market > S) {
    return(NA)
  }
  
  tryCatch({
    uniroot(function(sigma) bs_put_price(S, K, r, T, sigma) - P_market, 
            lower=sigma_lower, upper=sigma_upper)$root
  }, error=function(e) {
    message(sprintf("IV calculation failed for S=%.4f, K=%.4f, T=%.4f, P=%.4f, r=%.4f: %s", 
                    S, K, T, P_market, r, e$message))
    NA
  })
}

calculate_iv_put <- function(df) {
  df %>%
    mutate(
      Date = as.Date(Date),
      Expire_Date = as.Date(Expire_Date),

      T = as.numeric(difftime(Expire_Date, Date, units = "days")) / 365,

      IV = mapply(
        function(p_market, S, K, r, T_val) {
          if (is.na(p_market) || is.na(S) || is.na(K) || is.na(r) || is.na(T_val) || 
              T_val <= 0 || S <= 0 || K <= 0 || p_market <= 0) {
            return(NA)
          }

          implied_vol_put(p_market, S, K, r/100, T_val)
        },
        Close_Price, Target_Close_Price, Exercise_Price, rf, T
      )
    ) %>%
    select(-T)
}

```

```{r}
if (type == "call"){
  atm_max_vol_df <- calculate_iv_call(atm_max_vol_df)
} else if (type == "put") {
  atm_max_vol_df <- calculate_iv_put(atm_max_vol_df)
}

```


*合并新旧数据 list*
```{r}
dates_A <- names(result_list_latest)
dates_B <- names(update_list)
all_dates <- sort(unique(c(dates_A, dates_B)), decreasing = TRUE)

result_list <- list()

for (d in all_dates) {
  if (d %in% dates_A & d %in% dates_B) {

    df_A <- result_list_latest[[d]]
    df_B <- update_list[[d]]
    merged_df <- bind_rows(df_A, df_B) %>% distinct()
    result_list[[d]] <- merged_df
  } else if (d %in% dates_A) {

    result_list[[d]] <- result_list_latest[[d]]
  } else {

    result_list[[d]] <- update_list[[d]]
  }
}

for (d in names(result_list)) {
  result_list[[d]] <- result_list[[d]] %>% filter(if_any(everything(), ~ !is.na(.)))
}

```

*合并新旧数据 df*
```{r}
result_df <- bind_rows(atm_max_vol_df, atm_max_vol_df_latest) %>%
  distinct() %>%
  arrange(desc(Date))

```






## *更新IV数据，保存更新后的往期数据*
```{r}
library(openxlsx)
result_list_latest <- result_list
atm_max_vol_df_latest <- result_df

if (type == "call"){
  write.xlsx(atm_max_vol_df_latest, file = "IV_call_results.xlsx")
  save(result_list_latest, atm_max_vol_df_latest, file = "call_data.RData")
} else if (type == "put") {
  write.xlsx(atm_max_vol_df_latest, file = "IV_put_results.xlsx")
  save(result_list_latest, atm_max_vol_df_latest, file = "put_data.RData")
}
```










## *绘图*
```{r}
atm_max_vol_df_latest$Date <- as.Date(atm_max_vol_df_latest$Date)

fig <- plot_ly(
  data = atm_max_vol_df_latest,
  x = ~Date,
  y = ~IV,
  type = 'scatter',
  mode = 'lines+markers',
  line = list(color = 'steelblue', width = 2),
  marker = list(size = 5, color = 'steelblue', opacity = 0.8),
  hovertemplate = paste(
    "<b>日期:</b> %{x}<br>",
    "<b>隐含波动率:</b> %{y:.2%}<extra></extra>"
  )
)

fig <- fig %>%
  layout(
    title = list(
      text = "平值期权隐含波动率趋势",
      x = 0.5,
      font = list(size = 20, family = "Microsoft YaHei", color = "#333")
    ),
    xaxis = list(
      title = "日期",
      type = "date",
      tickformat = "%Y-%m-%d",
      rangeslider = list(visible = TRUE), 
      rangeselector = list( 
        buttons = list(
          list(count = 7, label = "1周", step = "day", stepmode = "backward"),
          list(count = 1, label = "1月", step = "month", stepmode = "backward"),
          list(count = 3, label = "3月", step = "month", stepmode = "backward"),
          list(count = 6, label = "半年", step = "month", stepmode = "backward"),
          list(step = "all", label = "全部")
        )
      )
    ),
    yaxis = list(
      title = "隐含波动率",
      tickformat = ".1%",
      rangemode = "tozero"
    ),
    hovermode = "x unified", 
    plot_bgcolor = "#fafafa",
    paper_bgcolor = "#ffffff",
    margin = list(t = 70)
  )


fig


```


## *隐含波动率锥*
```{r}
iv_cone <- atm_max_vol_df_latest %>%
  group_by(Expire_Date, Date) %>%
  summarise(mean_IV = mean(IV, na.rm = TRUE)) %>%
  group_by(Expire_Date) %>%
  summarise(
    p5 = quantile(mean_IV, 0.05, na.rm = TRUE),
    p25 = quantile(mean_IV, 0.25, na.rm = TRUE),
    median = quantile(mean_IV, 0.5, na.rm = TRUE),
    p75 = quantile(mean_IV, 0.75, na.rm = TRUE),
    p95 = quantile(mean_IV, 0.95, na.rm = TRUE)
  ) %>%
  arrange(Expire_Date)

latest_date <- max(atm_max_vol_df_latest$Date, na.rm = TRUE)
current_iv <- atm_max_vol_df_latest %>%
  filter(Date == latest_date) %>%
  group_by(Expire_Date) %>%
  summarise(current_IV = mean(IV, na.rm = TRUE)) %>%
  arrange(Expire_Date)

fig <- plot_ly() %>%

  add_trace(
    data = iv_cone,
    x = ~Expire_Date, y = ~p95,
    type = "scatter", mode = "lines",
    line = list(color = "lightgray"),
    name = "95分位"
  ) %>%
  add_trace(
    data = iv_cone,
    x = ~Expire_Date, y = ~p5,
    type = "scatter", mode = "lines",
    fill = "tonexty", fillcolor = "rgba(211,211,211,0.3)",
    line = list(color = "lightgray"),
    name = "5%-95% 区间"
  ) %>%

  add_trace(
    data = iv_cone,
    x = ~Expire_Date, y = ~p75,
    type = "scatter", mode = "lines",
    line = list(color = "skyblue"),
    name = "75分位"
  ) %>%
  add_trace(
    data = iv_cone,
    x = ~Expire_Date, y = ~p25,
    type = "scatter", mode = "lines",
    fill = "tonexty", fillcolor = "rgba(135,206,235,0.4)",
    line = list(color = "skyblue"),
    name = "25%-75% 区间"
  ) %>%

  add_trace(
    data = iv_cone,
    x = ~Expire_Date, y = ~median,
    type = "scatter", mode = "lines+markers",
    line = list(color = "#0055AA", width = 3),
    marker = list(size = 6, color = "#0055AA"),
    name = "中位数 (Median)"
  ) %>%

  add_trace(
    data = current_iv,
    x = ~Expire_Date, y = ~current_IV,
    type = "scatter", mode = "markers+text",
    marker = list(size = 10, color = "red", symbol = "diamond"),
    text = ~paste0("当前IV: ", round(current_IV, 4)),
    textposition = "top center",
    name = paste0("当前IV (", latest_date, ")")
  ) %>%

  layout(
  title = list(
    text = paste0("隐含波动率锥（Implied Volatility Cone） - 截止日期：", latest_date),
    x = 0.5,
    xanchor = "center",
    font = list(size = 20, family = "Microsoft YaHei", color = "#333")
  ),
  xaxis = list(
    title = "到期日 (Expiration Date)",
    type = "date",
    tickformat = "%Y-%m-%d",
    rangeslider = list(visible = TRUE),
    rangeselector = list(
      buttons = list(
        list(count = 14, label = "2周", step = "day", stepmode = "backward"),
        list(count = 1, label = "1月", step = "month", stepmode = "backward"),
        list(count = 3, label = "3月", step = "month", stepmode = "backward"),
        list(count = 6, label = "半年", step = "month", stepmode = "backward"),
        list(step = "all", label = "全部")
      )
    )
  ),
  yaxis = list(
    title = "隐含波动率 (Implied Volatility)",
    tickformat = ".1%",
    rangemode = "tozero",
    domain = c(0.0, 1)
  ),
  hovermode = "x unified",
  legend = list(
    orientation = "h", 
    x = 0.5, 
    y = 1.02, 
    xanchor = "center",
    yanchor = "bottom",
    bgcolor = "rgba(255,255,255,0.9)",
    bordercolor = "rgba(0,0,0,0.1)",
    borderwidth = 1,
    font = list(size = 12, family = "Microsoft YaHei")
  ),
  plot_bgcolor = "#fafafa",
  paper_bgcolor = "#ffffff",
  margin = list(t = 120)
)


fig

```


## *历史波动率锥*
```{r}
library(zoo)
library(plotly)

price_df <- atm_max_vol_df_latest %>%
  arrange(Date) %>%
  mutate(Return = log(Target_Close_Price / lag(Target_Close_Price))) %>%
  filter(!is.na(Return))

window_list <- c(10, 20, 60, 120)

hv_data <- data.frame()
for (w in window_list) {
  hv_tmp <- price_df %>%
    mutate(
      HV = rollapply(Return, w, sd, fill = NA, align = "right") * sqrt(252),
      Window = w
    )
  hv_data <- bind_rows(hv_data, hv_tmp)
}

hv_data <- hv_data %>% filter(!is.na(HV))

hv_cone_static <- hv_data %>%
  group_by(Window) %>%
  summarise(
    p5 = quantile(HV, 0.05, na.rm = TRUE),
    p25 = quantile(HV, 0.25, na.rm = TRUE),
    median = quantile(HV, 0.5, na.rm = TRUE),
    p75 = quantile(HV, 0.75, na.rm = TRUE),
    p95 = quantile(HV, 0.95, na.rm = TRUE)
  )

hv_points <- hv_data %>%
  mutate(frame = as.character(Date)) %>%
  select(Window, HV, frame)

p <- plot_ly() %>%
  add_trace(
    data = hv_cone_static,
    x = ~Window, y = ~p95,
    type = "scatter", mode = "lines",
    line = list(color = "lightgray"),
    name = "95分位", showlegend = FALSE
  ) %>%
  add_trace(
    data = hv_cone_static,
    x = ~Window, y = ~p5,
    type = "scatter", mode = "lines",
    fill = "tonexty", fillcolor = "rgba(211,211,211,0.3)",
    line = list(color = "lightgray"),
    name = "5-95分位区间", showlegend = TRUE
  ) %>%
  add_trace(
    data = hv_cone_static,
    x = ~Window, y = ~p75,
    type = "scatter", mode = "lines",
    line = list(color = "skyblue"), name = "75分位", showlegend = FALSE
  ) %>%
  add_trace(
    data = hv_cone_static,
    x = ~Window, y = ~p25,
    type = "scatter", mode = "lines",
    fill = "tonexty", fillcolor = "rgba(135,206,235,0.4)",
    line = list(color = "skyblue"),
    name = "25-75分位区间", showlegend = TRUE
  ) %>%
  add_trace(
    data = hv_cone_static,
    x = ~Window, y = ~median,
    type = "scatter", mode = "lines+markers",
    line = list(color = "steelblue", width = 3),
    marker = list(size = 5, color = "steelblue"),
    name = "中位数"
  ) %>%
  add_trace(
    data = hv_points,
    x = ~Window, y = ~HV,
    frame = ~frame,
    type = "scatter", mode = "markers+text",
    marker = list(size = 8, color = "red"),
    text = ~paste0(Window, "天HV: ", round(HV * 100, 2), "%"),
    textposition = "top center",
    hovertemplate = paste0(
      "窗口: %{x}天<br>",
      "日期: %{frame}<br>",
      "HV: %{y:.2%}<br><extra></extra>"
    ),
    name = "目标日期HV"
  ) %>%
  layout(
    title = list(
      text = "历史波动率锥",
      x = 0.5,
      font = list(size = 16, family = "Microsoft YaHei", color = "#333")
    ),
    xaxis = list(
      title = "滚动窗口长度（天）",
      tickvals = window_list,
      ticktext = paste0(window_list, "天")
    ),
    yaxis = list(
      title = "年化历史波动率 (HV)",
      tickformat = ".1%",
      range = c(0, 1)
    ),
    hovermode = "x unified",
    legend = list(
      orientation = "h",
      x = 0.5,
      xanchor = "center",
      y = -0.3 
    ),
    plot_bgcolor = "#fafafa",
    paper_bgcolor = "#ffffff",
    margin = list(t = 80, b = 120)
  ) %>%
  animation_opts(
    frame = 100,
    transition = 0,
    easing = "linear",
    redraw = FALSE
  ) %>%
  animation_slider(
    currentvalue = list(prefix = "日期: ", font = list(color = "black")),
    pad = list(t = 60)
  )

p

```

