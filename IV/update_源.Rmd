---
title: "update"
output: html_document
date: "2025-10-15"
---

```{r}
library(readxl)
library(dplyr)
library(stringr)
library(ggplot2)
library(scales)
library(plotly)
```


## *å¯¼å…¥å†å²æ•°æ®*
```{r}
#è¾“å…¥è®¤è´­ï¼ˆcallï¼‰or è®¤æ²½ï¼ˆputï¼‰
type <- "call"

if (type == "call"){
  # é’ˆå¯¹çœ‹æ¶¨æœŸæƒ
  load("call_data.RData")
} else if (type == "put") {
  # é’ˆå¯¹çœ‹è·ŒæœŸæƒ
  load("put_data.RData")
}
```


```{r}
# å°è£…ä¸€ä¸ªè¯»å–å’Œæ¸…æ´—å‡½æ•°
clean <- function(df) {
 
  # æŠŠç¬¬äºŒè¡Œç¬¬1åˆ—çš„æ•°æ®æ”¾åˆ°ç¬¬ä¸€è¡Œç¬¬1åˆ—
  df[1, 1] <- df[2, 1]
  # åˆ é™¤ç¬¬äºŒè¡Œ
  df <- df[-2, ]
  
  # ç¬¬ä¸€è¡Œè®¾ä¸ºåˆ—å
  colnames(df) <- as.character(unlist(df[1, ]))
  df <- df[-1, ]
  
  # æ—¥æœŸåˆ—è½¬æ¢ï¼ˆExcel æ•°å€¼ â†’ Dateï¼‰
  df[[1]] <- as.Date(as.numeric(df[[1]]), origin = "1899-12-30")
  
   # é™¤ç¬¬ä¸€åˆ—å¤–çš„æ‰€æœ‰åˆ—éƒ½è½¬æ¢ä¸º numeric
  if(ncol(df) > 1) {
    df[,-1] <- lapply(df[,-1], function(x) suppressWarnings(as.numeric(x)))
  }
  
  # è¿”å›ç»“æœ
  return(df)
}
```

## *å¯¼å…¥æ–°æ•°æ®*
```{r}
# åœ¨æ–‡ä»¶å¼€å¤´å®šä¹‰é…ç½®ï¼Œæ–¹ä¾¿ä¿®æ”¹
file_path <- "ä¸­è¯1000è®¤è´­update.xlsx"

# ä¸€æ¬¡æ€§è¯»å–æ‰€æœ‰æ•°æ®
close_price <- suppressMessages(read_excel(file_path, sheet = "æ”¶ç›˜ä»·", col_names = FALSE, skip = 2))
exercise_price <- suppressMessages(read_excel(file_path, sheet = "è¡Œæƒä»·æ ¼", col_names = FALSE, skip = 2))
target_close_price <- suppressMessages(read_excel(file_path, sheet = "æ ‡çš„æ”¶ç›˜ä»·", col_names = FALSE, skip = 2))
expire_date <- suppressMessages(read_excel(file_path, sheet = "åˆ°æœŸæ—¥", col_names = FALSE, skip = 2))
volume <- suppressMessages(read_excel(file_path, sheet = "æˆäº¤é‡", col_names = FALSE, skip = 2))
rf <- suppressMessages(read_excel(file_path, sheet = "æ— é£é™©åˆ©ç‡", col_names = FALSE, skip = 4))

ID <- data.frame(ID = t(close_price[1, -1]), stringsAsFactors = FALSE)

colnames(rf) <- c("æ—¶é—´", "æ— é£é™©åˆ©ç‡")
rf[,-1] <- lapply(rf[,-1], as.numeric)

close_price      <- clean(close_price)
exercise_price   <- clean(exercise_price)
target_close_price <- clean(target_close_price)
expire_date      <- clean(expire_date)
volume           <- clean(volume)

expire_date[-1] <- lapply(expire_date[-1], function(col) {
  as.Date(as.numeric(col), origin = "1899-12-30")
})

```


```{r}
if(!all(nrow(volume) == nrow(close_price), 
        nrow(volume) == nrow(target_close_price),
        nrow(volume) == nrow(expire_date),
        nrow(volume) == nrow(exercise_price))) {
  stop("æ‰€æœ‰æ•°æ®çš„è¡Œæ•°å¿…é¡»ç›¸åŒ")
}

if(!all(ncol(volume)-1 == nrow(ID))) {  #ç¬¬ä¸€åˆ—æ˜¯æ—¶é—´
  stop("æ‰€æœ‰æ•°æ®çš„IDå¿…é¡»ç›¸åŒ")
}

```


*ç­›é€‰ç¼ºå¤±çš„äº¤æ˜“æ—¥*
```{r}

latest_date <- as.Date(names(result_list_latest)[1])
today <- Sys.Date()

# æ·»åŠ ä¿æŠ¤ï¼šå¦‚æœ latest_date + 1 > today - 1ï¼Œç›´æ¥è¿”å›ç©ºåºåˆ—
if (latest_date + 1 > today - 1) {
  diff_dates <- diff_dates <- close_price$æ—¶é—´[close_price$æ—¶é—´ != today]  
                                      # é‚£å°±é‡æ–°æ£€æŸ¥é™¤äº†ä»Šå¤©çš„å…¨éƒ¨æ•°æ®æ˜¯å¦éƒ½åœ¨
} else {
  # æ‰¾å‡ºä¸¤è€…ä¹‹é—´çš„æ—¥æœŸï¼ˆä¸åŒ…å«è¿™ä¸¤ä¸ªç«¯ç‚¹ï¼‰
  #æ‰¾å‡ºç¼ºå¤±çš„æ—¥æœŸåºåˆ—
  diff_dates <- seq(from = latest_date + 1, to = today - 1, by = "day")
  diff_dates <- diff_dates[diff_dates %in% volume$æ—¶é—´]
}

print(diff_dates)
```


*å°†expire_dateï¼Œexercise_priceå†™å…¥ID*
```{r}
# è·å–æ‰€æœ‰IDåç§°
ids <- as.character(ID[[1]])

# ä¸ºIDæ•°æ®æ¡†æ·»åŠ åˆ°æœŸæ—¥åˆ—å’Œæ‰§è¡Œä»·æ ¼åˆ—
ID$Expire_Date <- as.Date(NA) # åˆ›å»ºåˆ°æœŸæ—¥ç©ºåˆ—
ID$Exercise_Price <- NA_real_  # åˆ›å»ºæ‰§è¡Œä»·æ ¼ç©ºåˆ—ï¼Œæ•°å€¼ç±»å‹

# åˆå¹¶å¡«å……åˆ°æœŸæ—¥å’Œæ‰§è¡Œä»·æ ¼
for(i in 1:length(ids)) {
  id <- ids[i]
  
  # å¡«å……åˆ°æœŸæ—¥
  if(id %in% colnames(expire_date)) {
    # è·å–è¯¥IDçš„åˆ°æœŸæ—¥ï¼ˆæ’é™¤NAå€¼ï¼‰
    expiry <- na.omit(expire_date[[id]])
    if(length(expiry) > 0) {
      ID$Expire_Date[i] <- expiry[1] # å–ç¬¬ä¸€ä¸ªéNAå€¼
    }
  }
  
  # å¡«å……æ‰§è¡Œä»·æ ¼
  if(id %in% colnames(exercise_price)) {
    # è·å–è¯¥IDçš„æ‰§è¡Œä»·æ ¼ï¼ˆæ’é™¤NAå€¼ï¼‰
    exercise_price_vals <- na.omit(exercise_price[[id]])
    if(length(exercise_price_vals) > 0) {
      ID$Exercise_Price[i] <- exercise_price_vals[1] # å–ç¬¬ä¸€ä¸ªéNAå€¼
    }
  }
}



```

*å¦‚æœåœ¨expire_dateä¹‹åè¿˜æœ‰æ•°æ®ï¼Œå°±å°†å…¶è®¾ç½®ä¸º0*
```{r}
for(id in ids) {
  if(id %in% colnames(close_price) && id %in% colnames(volume)) {
    # è·å–è¯¥IDçš„åˆ°æœŸæ—¥
    expiry_date <- ID$Expire_Date[ID[[1]] == id]
    
    if(!is.na(expiry_date)) {
      # æ‰¾åˆ°åˆ°æœŸæ—¥ä¹‹åçš„æ—¥æœŸç´¢å¼•
      expire_after_indices <- which(close_price$æ—¶é—´ > expiry_date)
      
      # å°†è¿™äº›ç´¢å¼•å¯¹åº”çš„å€¼è®¾ä¸º0
      if(length(expire_after_indices) > 0) {
        close_price[expire_after_indices, id] <- 0
        volume[expire_after_indices, id] <- 0
      }
    }
  }
}
```

*ç­›é€‰éœ€è¦æ—¥æœŸçš„æ•°æ®*
```{r}
# åˆ›å»ºç»“æœåˆ—è¡¨
update_list <- list()

# éå†æ¯ä¸ªæ—¥æœŸï¼Œåªå¤„ç† diff_dates
for(i in 1:nrow(volume)) {
  current_date <- volume$æ—¶é—´[i]
  
  # åªå¤„ç† diff_dates ä¸­çš„æ—¥æœŸ
  if(current_date %in% diff_dates) {
    
    # æå–è¯¥æ—¥æœŸçš„æ‰€æœ‰IDå’Œå¯¹åº”çš„æ•°æ®
    volume_values <- as.numeric(volume[i, -1]) # æ’é™¤ç¬¬ä¸€åˆ—(æ—¥æœŸ)
    close_price_values <- as.numeric(close_price[i, -1])
    target_close_price_values <- as.numeric(target_close_price[i, -1])
    
    # è·å–æ¯ä¸ªIDçš„åˆ°æœŸæ—¥å’Œè¡Œæƒä»·æ ¼
    expire_date_values <- ID$Expire_Date[match(ids, ID[[1]])]
    exercise_price_values <- ID$Exercise_Price[match(ids, ID[[1]])] #### éœ€ä¸éœ€è¦è¿‡æ»¤æ‰åˆ°æœŸæ—¥çš„æ•°æ®
    
    # åˆ›å»ºæ•°æ®æ¡†
    date_data <- data.frame(
      ID = ids,
      Volume = volume_values,
      Close_Price = close_price_values,
      Target_Close_Price = target_close_price_values,
      Expire_Date = expire_date_values,
      Exercise_Price = exercise_price_values,
      stringsAsFactors = FALSE
    )
    
    # è¿‡æ»¤æ‰æˆäº¤é‡å’Œæ”¶ç›˜ä»·éƒ½ä¸º0æˆ–NAçš„è®°å½•
    date_data <- subset(
      date_data,
      !( (is.na(Volume) | Volume == 0) & (is.na(Close_Price) | Close_Price == 0) )
    )
    
    # å¦‚æœæœ‰æœ‰æ•ˆæ•°æ®ï¼Œæ·»åŠ åˆ°ç»“æœåˆ—è¡¨
    if(nrow(date_data) > 0 && !all(is.na(date_data[, -1]))) {
      update_list[[as.character(current_date)]] <- date_data
    }
  }
}

cat("å¤„ç†å®Œæˆï¼Œæœ‰æ•ˆæ—¥æœŸæ•°é‡:", length(update_list), "\n")

```


*æ·»åŠ æ— é£é™©åˆ©ç‡rfï¼Œä½¿å…¶ä¸æ—¥æœŸåŒ¹é…*
```{r}
# ç»Ÿä¸€ç±»å‹
rf$æ—¶é—´ <- as.Date(rf$æ—¶é—´)

# å¾ªç¯æ·»åŠ  rf åˆ—
for(date_str in names(update_list)) {
  current_date <- as.Date(date_str)
  
  rf_row <- rf[rf$æ—¶é—´ == current_date, ]
  
  if(nrow(rf_row) > 0) {
    update_list[[date_str]]$rf <- rf_row$æ— é£é™©åˆ©ç‡[1]
  } else {
    warning(paste("åœ¨rfæ•°æ®æ¡†ä¸­æ‰¾ä¸åˆ°æ—¥æœŸ:", current_date))
    update_list[[date_str]]$rf <- NA
  }
}

# æ£€æŸ¥ç¼ºå¤±
missing_rf_dates <- sapply(update_list, function(x) all(is.na(x$rf)))
if(any(missing_rf_dates)) {
  cat("ä»¥ä¸‹æ—¥æœŸç¼ºå°‘rfå€¼:", toString(names(update_list)[missing_rf_dates]), "\n")
} else {
  cat("æ‰€æœ‰æ—¥æœŸéƒ½æˆåŠŸæ·»åŠ äº†rfå€¼\n")
}

```


*level æ’åº å®å€¼æœŸæƒ\è™šå€¼æœŸæƒ*
```{r}
#åœ¨æ‰€æœ‰è¡Œæƒä»·å¤§äºå¹³å€¼æœŸæƒçš„è¡Œæƒä»·çš„é‡Œé¢æœ€å°çš„é‚£ä¸ªè®¾ä¸º1ï¼Œç¬¬äºŒå°çš„è®¾ä¸º2â€¦â€¦ï¼Œæ‰€æœ‰è¡Œæƒä»·å°äºå¹³å€¼æœŸæƒçš„è¡Œæƒä»·çš„æœ€å¤§çš„é‚£ä¸ªè®¾ä¸º-1ï¼Œç¬¬äºŒå¤§çš„è®¾ä¸º-2â€¦â€¦å…è®¸å¹¶åˆ—

# ä¸ºæ¯ä¸ªæ—¥æœŸçš„æ•°æ®æ¡†æ·»åŠ  'level' åˆ—
for(date_str in names(update_list)) {
  date_data <- update_list[[date_str]]
  
  # è®¡ç®—è¡Œæƒä»·æ ¼ä¸æ ‡çš„æ”¶ç›˜ä»·çš„å·®å€¼
  date_data <- date_data %>%
    mutate(diff = abs(Target_Close_Price - Exercise_Price))
  
  # æ‰¾åˆ°ä¸æ ‡çš„æ”¶ç›˜ä»·æœ€æ¥è¿‘çš„æœŸæƒï¼Œæ ‡è®°ä¸ºå¹³å€¼æœŸæƒ (level = 0)
  min_diff_idx <- which.min(date_data$diff)
  date_data$level <- 0  # é»˜è®¤å€¼ä¸º0
  
  # è·å–å¹³å€¼æœŸæƒçš„è¡Œæƒä»·
  at_the_money_strike <- date_data$Exercise_Price[min_diff_idx]
  
  # åˆ†ç¦»å‡ºå¤§äºå¹³å€¼æœŸæƒçš„æœŸæƒå’Œå°äºå¹³å€¼æœŸæƒçš„æœŸæƒ
  greater_than_atm <- date_data %>%
    filter(Exercise_Price > at_the_money_strike)
  less_than_atm <- date_data %>%
    filter(Exercise_Price < at_the_money_strike)
  
  # ä¿ç•™å¹³å€¼æœŸæƒ
  at_the_money <- date_data %>%
    filter(Exercise_Price == at_the_money_strike)
  
  # å¯¹å¤§äºå¹³å€¼æœŸæƒçš„æœŸæƒæŒ‰è¡Œæƒä»·å‡åºæ’åºï¼Œå¹¶ç¼–å·ï¼ˆå¹¶åˆ—ï¼‰
  greater_than_atm <- greater_than_atm %>%
    arrange(Exercise_Price) %>%
    mutate(level = dense_rank(Exercise_Price))  # ä½¿ç”¨dense_rankå¤„ç†å¹¶åˆ—

  # å¯¹å°äºå¹³å€¼æœŸæƒçš„æœŸæƒæŒ‰è¡Œæƒä»·é™åºæ’åºï¼Œå¹¶ç¼–å·ï¼ˆå¹¶åˆ—ï¼‰
  less_than_atm <- less_than_atm %>%
    arrange(desc(Exercise_Price)) %>%
    mutate(level = -dense_rank(desc(Exercise_Price)))  # ä½¿ç”¨dense_rankå¤„ç†å¹¶åˆ—å¹¶åå‘ç¼–å·

  # åˆå¹¶å¤§äºå¹³å€¼æœŸæƒã€å°äºå¹³å€¼æœŸæƒä»¥åŠå¹³å€¼æœŸæƒ
  date_data <- bind_rows(greater_than_atm, less_than_atm, at_the_money)
  
  # æ›´æ–° result_list ä¸­çš„æ•°æ®
  update_list[[date_str]] <- date_data
}

```


*å¯¹æ¯”è¡Œæƒä»·æ ¼ä¸æ ‡çš„æ”¶ç›˜ä»·ï¼Œç¡®å®šå½“æ—¥çš„å¹³å€¼æœŸæƒï¼ˆå¯èƒ½æœ‰å¤šä¸ªï¼‰*
```{r}
ID$Exercise_Price <- as.numeric(ID$Exercise_Price)
# å¤åˆ¶ update_list
At_the_money <- update_list  

# éå†æ¯ä¸ªæ—¥æœŸçš„æ•°æ®ï¼Œç­›é€‰æœ€æ¥è¿‘ at-the-money çš„è®°å½•
At_the_money <- lapply(At_the_money, function(date_data) {
  # è®¡ç®—å·®å€¼ï¼ˆæ³¨æ„ exercise price è¦é™¤ä»¥ 100ï¼‰
  date_data <- date_data %>%
    mutate(diff = abs(Target_Close_Price - Exercise_Price))
  
  # æ‰¾åˆ°æœ€å°å·®å€¼
  min_diff <- min(date_data$diff, na.rm = TRUE)
  
  # ä¿ç•™æœ€å°å·®å€¼çš„è¡Œï¼ˆå¯èƒ½æœ‰å¤šä¸ªï¼‰
  date_data <- date_data %>% filter(diff == min_diff)
  
  return(date_data)
})

```


## *ç­›é€‰æ‰ä¸´è¿‘åˆ°æœŸæ—¥çš„åˆçº¦*
```{r}
library(lubridate)

for (i in seq_along(At_the_money)) {
  current_date <- as.Date(names(At_the_money)[i])  # æå–è¡¨åçš„æ—¥æœŸ
  df <- At_the_money[[i]]
  
  # ç¡®ä¿åˆ°æœŸæ—¥æ˜¯æ—¥æœŸç±»å‹
  df$Expire_Date <- as.Date(df$Expire_Date)
  
  # ç­›é€‰ï¼šåˆ°æœŸæ—¥è·ç¦»å½“å‰æ—¥æœŸ > 1 å¤©
  df <- df[df$Expire_Date - current_date > 1, ]
  
  # å›å†™
  At_the_money[[i]] <- df
}

```


*æŒ‰æ¯æ—¥æœ€å¤§æˆäº¤é‡ç­›é€‰ä¸»åŠ›åˆçº¦*
```{r}
# æ¯æ—¥å–å¹³å€¼æœŸæƒæˆäº¤é‡æœ€å¤§çš„åˆçº¦
atm_max_vol <- lapply(At_the_money, function(date_data) {
  if(nrow(date_data) == 0) return(date_data[0, ])  # ç©ºè¡¨å¤„ç†
  
  max_vol <- max(date_data$Volume, na.rm = TRUE)
  date_data %>% filter(Volume == max_vol)
})

# åˆå¹¶æˆæ€»è¡¨ï¼Œå¹¶å»æ‰ diff
atm_max_vol_df <- bind_rows(atm_max_vol, .id = "Date") %>%
  select(-diff)
```


*è®¡ç®—éšå«æ³¢åŠ¨ç‡* 
```{r}
##########################  Black-Scholes æ¬§å¼çœ‹æ¶¨æœŸæƒå®šä»·å…¬å¼  ###################################

bs_call_price <- function(S, K, r, T, sigma) {
  d1 <- (log(S/K) + (r + 0.5*sigma^2)*T) / (sigma*sqrt(T))
  d2 <- d1 - sigma*sqrt(T)
  C <- S * pnorm(d1) - K * exp(-r*T) * pnorm(d2)
  return(C)
}

# ç”¨å¸‚åœºä»·æ ¼åè§£éšå«æ³¢åŠ¨ç‡
implied_vol_call <- function(C_market, S, K, r, T, 
                        sigma_lower=1e-6, sigma_upper=5) {
  # æ£€æŸ¥è¾“å…¥æœ‰æ•ˆæ€§
  if (C_market <= max(S - K * exp(-r*T), 0) || C_market > S) {
    return(NA)  # æœŸæƒä»·æ ¼è¶…å‡ºåˆç†èŒƒå›´
  }
  
  tryCatch({
    uniroot(function(sigma) bs_call_price(S, K, r, T, sigma) - C_market, 
            lower=sigma_lower, upper=sigma_upper)$root
  }, error=function(e) {
    # æ‰“å°é”™è¯¯ä¿¡æ¯ä»¥ä¾¿è°ƒè¯•
    message(sprintf("IV calculation failed for S=%.4f, K=%.4f, T=%.4f, C=%.4f, r=%.4f: %s", 
                    S, K, T, C_market, r, e$message))
    NA
  })
}

# è®¡ç®—éšå«æ³¢åŠ¨ç‡
calculate_iv_call <- function(df) {
  df %>%
    mutate(
      # ç¡®ä¿æ—¥æœŸåˆ—æ˜¯æ­£ç¡®çš„æ ¼å¼
      Date = as.Date(Date),
      Expire_Date = as.Date(Expire_Date),
      
      # è®¡ç®—å‰©ä½™æ—¶é—´ï¼ˆä»¥å¹´ä¸ºå•ä½ï¼‰
      T = as.numeric(difftime(Expire_Date, Date, units = "days")) / 365,
      
      # è®¡ç®—éšå«æ³¢åŠ¨ç‡
      IV = mapply(
        function(c_market, S, K, r, T_val) {
          # æ£€æŸ¥è¾“å…¥æ˜¯å¦æœ‰æ•ˆ
          if (is.na(c_market) || is.na(S) || is.na(K) || is.na(r) || is.na(T_val) || 
              T_val <= 0 || S <= 0 || K <= 0 || c_market <= 0) {
            return(NA)
          }
          
          # è°ƒç”¨éšå«æ³¢åŠ¨ç‡è®¡ç®—å‡½æ•°
          implied_vol_call(c_market, S, K, r/100, T_val)  # æ³¨æ„ï¼šrfæ˜¯ç™¾åˆ†æ¯”ï¼Œéœ€è¦é™¤ä»¥100
        },
        Close_Price, Target_Close_Price, Exercise_Price, rf, T
      )
    ) %>%
    select(-T)  # åˆ é™¤ä¸´æ—¶åˆ—
}




##########################  Black-Scholes æ¬§å¼çœ‹è·ŒæœŸæƒå®šä»·å…¬å¼  ###################################

bs_put_price <- function(S, K, r, T, sigma) {
  d1 <- (log(S/K) + (r + 0.5*sigma^2)*T) / (sigma*sqrt(T))
  d2 <- d1 - sigma*sqrt(T)
  P <- K * exp(-r*T) * pnorm(-d2) - S * pnorm(-d1)
  return(P)
}

# ç”¨å¸‚åœºä»·æ ¼åè§£éšå«æ³¢åŠ¨ç‡ï¼ˆé’ˆå¯¹çœ‹è·ŒæœŸæƒï¼‰
implied_vol_put <- function(P_market, S, K, r, T, 
                            sigma_lower=1e-6, sigma_upper=5) {
  # æ£€æŸ¥è¾“å…¥æœ‰æ•ˆæ€§
  if (P_market <= max(K * exp(-r*T) - S, 0) || P_market > S) {
    return(NA)  # æœŸæƒä»·æ ¼è¶…å‡ºåˆç†èŒƒå›´
  }
  
  tryCatch({
    uniroot(function(sigma) bs_put_price(S, K, r, T, sigma) - P_market, 
            lower=sigma_lower, upper=sigma_upper)$root
  }, error=function(e) {
    # æ‰“å°é”™è¯¯ä¿¡æ¯ä»¥ä¾¿è°ƒè¯•
    message(sprintf("IV calculation failed for S=%.4f, K=%.4f, T=%.4f, P=%.4f, r=%.4f: %s", 
                    S, K, T, P_market, r, e$message))
    NA
  })
}

# è®¡ç®—éšå«æ³¢åŠ¨ç‡ï¼ˆé’ˆå¯¹çœ‹è·ŒæœŸæƒï¼‰
calculate_iv_put <- function(df) {
  df %>%
    mutate(
      # ç¡®ä¿æ—¥æœŸåˆ—æ˜¯æ­£ç¡®çš„æ ¼å¼
      Date = as.Date(Date),
      Expire_Date = as.Date(Expire_Date),
      
      # è®¡ç®—å‰©ä½™æ—¶é—´ï¼ˆä»¥å¹´ä¸ºå•ä½ï¼‰
      T = as.numeric(difftime(Expire_Date, Date, units = "days")) / 365,
      
      # è®¡ç®—éšå«æ³¢åŠ¨ç‡
      IV = mapply(
        function(p_market, S, K, r, T_val) {
          # æ£€æŸ¥è¾“å…¥æ˜¯å¦æœ‰æ•ˆ
          if (is.na(p_market) || is.na(S) || is.na(K) || is.na(r) || is.na(T_val) || 
              T_val <= 0 || S <= 0 || K <= 0 || p_market <= 0) {
            return(NA)
          }
          
          # è°ƒç”¨éšå«æ³¢åŠ¨ç‡è®¡ç®—å‡½æ•°
          implied_vol_put(p_market, S, K, r/100, T_val)  # æ³¨æ„ï¼šrfæ˜¯ç™¾åˆ†æ¯”ï¼Œéœ€è¦é™¤ä»¥100
        },
        Close_Price, Target_Close_Price, Exercise_Price, rf, T
      )
    ) %>%
    select(-T)  # åˆ é™¤ä¸´æ—¶åˆ—
}

```

```{r}
if (type == "call"){
  # åº”ç”¨å‡½æ•°è®¡ç®—IVï¼ˆé’ˆå¯¹çœ‹æ¶¨æœŸæƒï¼‰
  atm_max_vol_df <- calculate_iv_call(atm_max_vol_df)
} else if (type == "put") {
  # åº”ç”¨å‡½æ•°è®¡ç®—IVï¼ˆé’ˆå¯¹çœ‹è·ŒæœŸæƒï¼‰
  atm_max_vol_df <- calculate_iv_put(atm_max_vol_df)
}

```


*åˆå¹¶æ–°æ—§æ•°æ® list*
```{r}
# 1 æå–æ—¥æœŸåç§°
dates_A <- names(result_list_latest)
dates_B <- names(update_list)
all_dates <- sort(unique(c(dates_A, dates_B)), decreasing = TRUE)  # é™åºæ’åˆ—

# 2 åˆ›å»ºæ–° list
result_list <- list()

# 3 åˆå¹¶é€»è¾‘
for (d in all_dates) {
  if (d %in% dates_A & d %in% dates_B) {
    # ä¸¤è¾¹éƒ½æœ‰è¯¥æ—¥æœŸ â†’ åˆå¹¶å¹¶å»é‡
    df_A <- result_list_latest[[d]]
    df_B <- update_list[[d]]
    merged_df <- bind_rows(df_A, df_B) %>% distinct()
    result_list[[d]] <- merged_df
  } else if (d %in% dates_A) {
    # ä»…åœ¨ A ä¸­
    result_list[[d]] <- result_list_latest[[d]]
  } else {
    # ä»…åœ¨ B ä¸­
    result_list[[d]] <- update_list[[d]]
  }
}

# 4 å»é™¤æ¯ä¸ªæ•°æ®æ¡†ä¸­çš„ NA è¡Œ
for (d in names(result_list)) {
  result_list[[d]] <- result_list[[d]] %>% filter(if_any(everything(), ~ !is.na(.)))
}

```

*åˆå¹¶æ–°æ—§æ•°æ® df*
```{r}
# åˆå¹¶æ–°æ—§æ•°æ®å¹¶å»é‡
# å¯¹æ¯ä¸ªæ—¥æœŸï¼Œå¦‚æœæœ‰é‡å¤ï¼Œä¿ç•™Volumeæœ€å¤§çš„é‚£ä¸ª
result_df <- bind_rows(atm_max_vol_df, atm_max_vol_df_latest) %>%
  distinct() %>%
  group_by(Date) %>%
  slice_max(Volume, n = 1, with_ties = FALSE) %>%  # åœ¨æ¯ä¸ªæ—¥æœŸç»„å†…ï¼Œé€‰æ‹©Volumeæœ€å¤§çš„è¡Œ
  ungroup() %>%
  arrange(desc(Date))

```






## *æ›´æ–°IVæ•°æ®ï¼Œä¿å­˜æ›´æ–°åçš„å¾€æœŸæ•°æ®*
```{r}
library(openxlsx)
result_list_latest <- result_list
atm_max_vol_df_latest <- result_df

if (type == "call"){
  # é’ˆå¯¹çœ‹æ¶¨æœŸæƒ
  write.xlsx(atm_max_vol_df_latest, file = "IV_call_results.xlsx")
  save(result_list_latest, atm_max_vol_df_latest, file = "call_data.RData")
} else if (type == "put") {
  # é’ˆå¯¹çœ‹è·ŒæœŸæƒ
  write.xlsx(atm_max_vol_df_latest, file = "IV_put_results.xlsx")
  save(result_list_latest, atm_max_vol_df_latest, file = "put_data.RData")
}
```




## *ç»˜å›¾*
```{r}
# ç¡®ä¿æ—¥æœŸæ ¼å¼æ­£ç¡®
atm_max_vol_df_latest$Date <- as.Date(atm_max_vol_df_latest$Date)

# åˆ›å»ºäº¤äº’å¼å›¾è¡¨
fig <- plot_ly(
  data = atm_max_vol_df_latest,
  x = ~Date,
  y = ~IV,
  type = 'scatter',
  mode = 'lines+markers',
  line = list(color = 'steelblue', width = 2),
  marker = list(size = 5, color = 'steelblue', opacity = 0.8),
  hovertemplate = paste(
    "<b>æ—¥æœŸ:</b> %{x}<br>",
    "<b>éšå«æ³¢åŠ¨ç‡:</b> %{y:.2%}<extra></extra>"
  )
)

# æ·»åŠ å¸ƒå±€
fig <- fig %>%
  layout(
    title = list(
      text = "å¹³å€¼æœŸæƒéšå«æ³¢åŠ¨ç‡è¶‹åŠ¿",
      x = 0.5,
      font = list(size = 20, family = "Microsoft YaHei", color = "#333")
    ),
    xaxis = list(
      title = "æ—¥æœŸ",
      type = "date",
      tickformat = "%Y-%m-%d",
      rangeslider = list(visible = TRUE),  # âœ… æ»‘åŠ¨æ¡
      rangeselector = list(                # âœ… å¿«æ·æ—¶é—´é€‰æ‹©
        buttons = list(
          list(count = 7, label = "1å‘¨", step = "day", stepmode = "backward"),
          list(count = 1, label = "1æœˆ", step = "month", stepmode = "backward"),
          list(count = 3, label = "3æœˆ", step = "month", stepmode = "backward"),
          list(count = 6, label = "åŠå¹´", step = "month", stepmode = "backward"),
          list(step = "all", label = "å…¨éƒ¨")
        )
      )
    ),
    yaxis = list(
      title = "éšå«æ³¢åŠ¨ç‡",
      tickformat = ".1%",
      rangemode = "tozero"
    ),
    hovermode = "x unified",  # âœ… æ‚¬åœç»Ÿä¸€æç¤ºæ¡†
    plot_bgcolor = "#fafafa",
    paper_bgcolor = "#ffffff",
    margin = list(t = 70)
  )

# æ˜¾ç¤ºå›¾è¡¨
fig


```


## *éšå«æ³¢åŠ¨ç‡é”¥*
```{r}
#------------------------------
# è®¡ç®—æ¯ä¸ªåˆ°æœŸæ—¥çš„éšå«æ³¢åŠ¨ç‡åˆ†å¸ƒ
#------------------------------
iv_cone <- atm_max_vol_df_latest %>%
  group_by(Expire_Date, Date) %>%
  summarise(mean_IV = mean(IV, na.rm = TRUE)) %>%
  group_by(Expire_Date) %>%
  summarise(
    p5 = quantile(mean_IV, 0.05, na.rm = TRUE),
    p25 = quantile(mean_IV, 0.25, na.rm = TRUE),
    median = quantile(mean_IV, 0.5, na.rm = TRUE),
    p75 = quantile(mean_IV, 0.75, na.rm = TRUE),
    p95 = quantile(mean_IV, 0.95, na.rm = TRUE)
  ) %>%
  arrange(Expire_Date)

#------------------------------
# æå–æœ€æ–°æ—¥æœŸçš„å½“å‰IVï¼ˆç”¨äºçº¢ç‚¹æ ‡è®°ï¼‰
#------------------------------
latest_date <- max(atm_max_vol_df_latest$Date, na.rm = TRUE)
current_iv <- atm_max_vol_df_latest %>%
  filter(Date == latest_date) %>%
  group_by(Expire_Date) %>%
  summarise(current_IV = mean(IV, na.rm = TRUE)) %>%
  arrange(Expire_Date)

#------------------------------
# ç»˜åˆ¶ Plotly æ³¢åŠ¨ç‡é”¥ + æ»‘åŠ¨æ¡å¸ƒå±€
#------------------------------
fig <- plot_ly() %>%
  #-------------------------------------------------------
  # 5%-95% ç°è‰²åŒºé—´ / Gray band for 5%-95%
  #-------------------------------------------------------
  add_trace(
    data = iv_cone,
    x = ~Expire_Date, y = ~p95,
    type = "scatter", mode = "lines",
    line = list(color = "lightgray"),
    name = "95åˆ†ä½"
  ) %>%
  add_trace(
    data = iv_cone,
    x = ~Expire_Date, y = ~p5,
    type = "scatter", mode = "lines",
    fill = "tonexty", fillcolor = "rgba(211,211,211,0.3)",
    line = list(color = "lightgray"),
    name = "5%-95% åŒºé—´"
  ) %>%
  #-------------------------------------------------------
  # 25%-75% è“è‰²åŒºé—´ / Blue band for 25%-75%
  #-------------------------------------------------------
  add_trace(
    data = iv_cone,
    x = ~Expire_Date, y = ~p75,
    type = "scatter", mode = "lines",
    line = list(color = "skyblue"),
    name = "75åˆ†ä½"
  ) %>%
  add_trace(
    data = iv_cone,
    x = ~Expire_Date, y = ~p25,
    type = "scatter", mode = "lines",
    fill = "tonexty", fillcolor = "rgba(135,206,235,0.4)",
    line = list(color = "skyblue"),
    name = "25%-75% åŒºé—´"
  ) %>%
  #-------------------------------------------------------
  # ä¸­ä½æ•°çº¿ / Median line
  #-------------------------------------------------------
  add_trace(
    data = iv_cone,
    x = ~Expire_Date, y = ~median,
    type = "scatter", mode = "lines+markers",
    line = list(color = "#0055AA", width = 3),
    marker = list(size = 6, color = "#0055AA"),
    name = "ä¸­ä½æ•° (Median)"
  ) %>%
  #-------------------------------------------------------
  # å½“å‰IVï¼ˆçº¢è‰²è±å½¢ï¼‰/ Current IV (red diamond marker)
  #-------------------------------------------------------
  add_trace(
    data = current_iv,
    x = ~Expire_Date, y = ~current_IV,
    type = "scatter", mode = "markers+text",
    marker = list(size = 10, color = "red", symbol = "diamond"),
    text = ~paste0("å½“å‰IV: ", round(current_IV, 4)),
    textposition = "top center",
    name = paste0("å½“å‰IV (", latest_date, ")")
  ) %>%
  #-------------------------------------------------------
  # å¸ƒå±€è®¾ç½® / Layout customization
  #-------------------------------------------------------
  layout(
  title = list(
    text = paste0("éšå«æ³¢åŠ¨ç‡é”¥ï¼ˆImplied Volatility Coneï¼‰ - æˆªæ­¢æ—¥æœŸï¼š", latest_date),
    x = 0.5,
    xanchor = "center",
    font = list(size = 20, family = "Microsoft YaHei", color = "#333")
  ),
  xaxis = list(
    title = "åˆ°æœŸæ—¥ (Expiration Date)",
    type = "date",
    tickformat = "%Y-%m-%d",
    rangeslider = list(visible = TRUE),
    rangeselector = list(
      buttons = list(
        list(count = 14, label = "2å‘¨", step = "day", stepmode = "backward"),
        list(count = 1, label = "1æœˆ", step = "month", stepmode = "backward"),
        list(count = 3, label = "3æœˆ", step = "month", stepmode = "backward"),
        list(count = 6, label = "åŠå¹´", step = "month", stepmode = "backward"),
        list(step = "all", label = "å…¨éƒ¨")
      )
    )
  ),
  yaxis = list(
    title = "éšå«æ³¢åŠ¨ç‡ (Implied Volatility)",
    tickformat = ".1%",
    rangemode = "tozero",
    domain = c(0.0, 1)
  ),
  hovermode = "x unified",
  legend = list(
    orientation = "h",        # æ°´å¹³æ’åˆ—
    x = 0.5,                  # å±…ä¸­
    y = 1.03,                  # è°ƒæ•´å›¾ä¾‹é«˜åº¦
    xanchor = "center",
    yanchor = "bottom",
    bgcolor = "rgba(255,255,255,0.9)",
    bordercolor = "rgba(0,0,0,0.1)",
    borderwidth = 1,
    font = list(size = 10, family = "Microsoft YaHei")
  ),
  plot_bgcolor = "#fafafa",
  paper_bgcolor = "#ffffff",
  margin = list(t = 120)  # ğŸ’¡ å¢åŠ é¡¶éƒ¨ç•™ç™½ï¼Œé¿å…æ ‡é¢˜ä¸å›¾ä¾‹é‡å 
)



#------------------------------
# æ˜¾ç¤ºå›¾å½¢
#------------------------------
fig
```


## *å†å²æ³¢åŠ¨ç‡é”¥*
```{r}
library(zoo)
library(plotly)

#----------------------------------------
# Step 1: è®¡ç®—æ¯æ—¥å¯¹æ•°æ”¶ç›Šç‡
#----------------------------------------
price_df <- atm_max_vol_df_latest %>%
  arrange(Date) %>%
  mutate(Return = log(Target_Close_Price / lag(Target_Close_Price))) %>%
  filter(!is.na(Return))

#----------------------------------------
# Step 2: å®šä¹‰æ»šåŠ¨çª—å£
#----------------------------------------
window_list <- c(10, 20, 60, 120)

#----------------------------------------
# Step 3: è®¡ç®—æ»šåŠ¨å¹´åŒ–å†å²æ³¢åŠ¨ç‡
#----------------------------------------
hv_data <- data.frame()
for (w in window_list) {
  hv_tmp <- price_df %>%
    mutate(
      HV = rollapply(Return, w, sd, fill = NA, align = "right") * sqrt(252),
      Window = w
    )
  hv_data <- bind_rows(hv_data, hv_tmp)
}

hv_data <- hv_data %>% filter(!is.na(HV))

#----------------------------------------
# Step 4: é™æ€åˆ†ä½æ•°ï¼ˆç”¨æ‰€æœ‰æ•°æ®è®¡ç®—ä¸€æ¬¡ï¼‰
#----------------------------------------
hv_cone_static <- hv_data %>%
  group_by(Window) %>%
  summarise(
    p5 = quantile(HV, 0.05, na.rm = TRUE),
    p25 = quantile(HV, 0.25, na.rm = TRUE),
    median = quantile(HV, 0.5, na.rm = TRUE),
    p75 = quantile(HV, 0.75, na.rm = TRUE),
    p95 = quantile(HV, 0.95, na.rm = TRUE)
  )

#----------------------------------------
# Step 5: åŠ¨ç”»çº¢ç‚¹æ•°æ®
#----------------------------------------
hv_points <- hv_data %>%
  mutate(frame = as.character(Date)) %>%
  select(Window, HV, frame)

#----------------------------------------
# Step 6: ç»˜å›¾ä¼˜åŒ–ç‰ˆï¼ˆé¿å…æ»‘æ¡ä¸å›¾ä¾‹é‡å ï¼‰
#----------------------------------------
p <- plot_ly() %>%
  #-------------------------------------------------------
  # 5%-95% ç°è‰²åŒºé—´ / Gray band for 5%-95%
  #-------------------------------------------------------
  add_trace(
    data = hv_cone_static,
    x = ~Window, y = ~p95,
    type = "scatter", mode = "lines",
    line = list(color = "lightgray"),
    name = "95åˆ†ä½"
  ) %>%
  add_trace(
    data = hv_cone_static,
    x = ~Window, y = ~p5,
    type = "scatter", mode = "lines",
    fill = "tonexty", fillcolor = "rgba(211,211,211,0.3)",
    line = list(color = "lightgray"),
    name = "5%-95% åŒºé—´"
  ) %>%
  #-------------------------------------------------------
  # 25%-75% è“è‰²åŒºé—´ / Blue band for 25%-75%
  #-------------------------------------------------------
  add_trace(
    data = hv_cone_static,
    x = ~Window, y = ~p75,
    type = "scatter", mode = "lines",
    line = list(color = "skyblue"),
    name = "75åˆ†ä½"
  ) %>%
  add_trace(
    data = hv_cone_static,
    x = ~Window, y = ~p25,
    type = "scatter", mode = "lines",
    fill = "tonexty", fillcolor = "rgba(135,206,235,0.4)",
    line = list(color = "skyblue"),
    name = "25%-75% åŒºé—´"
  ) %>%
  #-------------------------------------------------------
  # ä¸­ä½æ•°çº¿ / Median line
  #-------------------------------------------------------
  add_trace(
    data = hv_cone_static,
    x = ~Window, y = ~median,
    type = "scatter", mode = "lines+markers",
    line = list(color = "#0055AA", width = 3),
    marker = list(size = 6, color = "#0055AA"),
    name = "ä¸­ä½æ•° (Median)"
  ) %>%
  # çº¢ç‚¹åŠ¨ç”»
  add_trace(
    data = hv_points,
    x = ~Window, y = ~HV,
    frame = ~frame,
    type = "scatter", mode = "markers+text",
    marker = list(size = 8, color = "red"),
    text = ~paste0(Window, "å¤©HV: ", round(HV * 100, 2), "%"),
    textposition = "top center",
    hovertemplate = paste0(
      "çª—å£: %{x}å¤©<br>",
      "æ—¥æœŸ: %{frame}<br>",
      "HV: %{y:.2%}<br><extra></extra>"
    ),
    name = "ç›®æ ‡æ—¥æœŸHV"
  ) %>%
  layout(
    title = list(
      text = "å†å²æ³¢åŠ¨ç‡é”¥",
      x = 0.5,
      font = list(size = 16, family = "Microsoft YaHei", color = "#333")
    ),
    xaxis = list(
      title = "æ»šåŠ¨çª—å£é•¿åº¦ï¼ˆå¤©ï¼‰",
      tickvals = window_list,
      ticktext = paste0(window_list, "å¤©")
    ),
    yaxis = list(
      title = "å¹´åŒ–å†å²æ³¢åŠ¨ç‡ (HV)",
      tickformat = ".1%",
      range = c(0, 1)
    ),
    hovermode = "x unified",
    legend = list(
      orientation = "h",
      x = 0.5,
      xanchor = "center",
      y = 1.03   # âœ… å›¾ä¾‹å¾€ä¸‹æŒªï¼Œé˜²æ­¢é‡å æ»‘æ¡
    ),
    plot_bgcolor = "#fafafa",
    paper_bgcolor = "#ffffff",
    margin = list(t = 80, b = 120) # âœ… åº•éƒ¨ç•™å‡ºè¶³å¤Ÿç©ºé—´
  ) %>%
  animation_opts(
    frame = 100,
    transition = 0,
    easing = "linear",
    redraw = FALSE
  ) %>%
  animation_slider(
    currentvalue = list(prefix = "æ—¥æœŸ: ", font = list(color = "black")),
    pad = list(t = 60)  # æ»‘æ¡ä¸å›¾ä½“ä¿æŒè·ç¦»
  )

p

```


## *æ ‡çš„å†å²æ³¢åŠ¨ç‡*
```{r}
# è®¡ç®—å†å²æ³¢åŠ¨ç‡
library(zoo)
library(plotly)

# ä½¿ç”¨å·²æœ‰çš„æ•°æ®è®¡ç®—å†å²æ³¢åŠ¨ç‡
price_df <- atm_max_vol_df_latest %>%
  arrange(Date) %>%
  mutate(Return = log(Target_Close_Price / lag(Target_Close_Price))) %>%
  filter(!is.na(Return))

window_list <- c(10, 20, 60, 120)

# è®¡ç®—ä¸åŒçª—å£æœŸçš„å†å²æ³¢åŠ¨ç‡
hv_data <- data.frame()
for (w in window_list) {
  hv_tmp <- price_df %>%
    mutate(
      HV = rollapply(Return, w, sd, fill = NA, align = "right") * sqrt(252),
      Window = paste0(w, "å¤©")
    )
  hv_data <- bind_rows(hv_data, hv_tmp)
}

hv_data <- hv_data %>% filter(!is.na(HV))

# ç»˜åˆ¶å†å²æ³¢åŠ¨ç‡æ—¶é—´åºåˆ—å›¾
fig <- plot_ly() 

# ä¸ºæ¯ä¸ªçª—å£æœŸæ·»åŠ ä¸€æ¡çº¿
colors <- c("#1f77b4", "#ff7f0e", "#2ca02c", "#d62728")

for (i in 1:length(window_list)) {
  w <- window_list[i]
  window_data <- hv_data %>% filter(Window == paste0(w, "å¤©"))
  
  fig <- fig %>%
    add_trace(
      data = window_data,
      x = ~Date,
      y = ~HV,
      type = 'scatter',
      mode = 'lines',
      name = paste0(w, "å¤©å†å²æ³¢åŠ¨ç‡"),
      line = list(color = colors[i], width = 2),
      hovertemplate = paste(
        "<b>æ—¥æœŸ:</b> %{x}<br>",
        "<b>", w, "å¤©HV:</b> %{y:.2%}<extra></extra>"
      )
    )
}

# æ·»åŠ å½“å‰æ—¥æœŸæ ‡è®°
latest_date <- max(hv_data$Date, na.rm = TRUE)
latest_hv <- hv_data %>% 
  filter(Date == latest_date) %>%
  arrange(Window)

for (i in 1:nrow(latest_hv)) {
  fig <- fig %>%
    add_trace(
      x = ~c(latest_hv$Date[i]),
      y = ~c(latest_hv$HV[i]),
      type = 'scatter',
      mode = 'markers',
      marker = list(
        size = 8, 
        color = colors[i],
        symbol = "diamond"
      ),
      name = paste0("å½“å‰", latest_hv$Window[i]),
      showlegend = FALSE,
      hovertemplate = paste(
        "<b>æ—¥æœŸ:</b>", latest_date, "<br>",
        "<b>", gsub("å¤©", "", latest_hv$Window[i]), "å¤©HV:</b> %{y:.2%}<extra></extra>"
      )
    )
}

fig <- fig %>%
  layout(
    title = list(
      text = "å†å²æ³¢åŠ¨ç‡æ—¶é—´åºåˆ—",
      x = 0.5,
      font = list(size = 20, family = "Microsoft YaHei", color = "#333")
    ),
    xaxis = list(
      title = "æ—¥æœŸ",
      type = "date",
      tickformat = "%Y-%m-%d",
      rangeslider = list(visible = TRUE),
      rangeselector = list(
        buttons = list(
          list(count = 1, label = "1æœˆ", step = "month", stepmode = "backward"),
          list(count = 3, label = "3æœˆ", step = "month", stepmode = "backward"),
          list(count = 6, label = "6æœˆ", step = "month", stepmode = "backward"),
          list(count = 1, label = "1å¹´", step = "year", stepmode = "backward"),
          list(step = "all", label = "å…¨éƒ¨")
        )
      )
    ),
    yaxis = list(
      title = "å¹´åŒ–å†å²æ³¢åŠ¨ç‡",
      tickformat = ".1%",
      rangemode = "tozero",
      domain = c(0.0, 1)
    ),
    hovermode = "x unified",
    legend = list(
    orientation = "h", 
    x = 0.5, 
    y = 1.02, 
    xanchor = "center",
    yanchor = "bottom",
    bgcolor = "rgba(255,255,255,0.9)",
    bordercolor = "rgba(0,0,0,0.1)",
    borderwidth = 1,
    font = list(size = 12, family = "Microsoft YaHei")
  ),
    plot_bgcolor = "#fafafa",
    paper_bgcolor = "#ffffff",
    margin = list(t = 120, b = 120)
  )

fig

```
